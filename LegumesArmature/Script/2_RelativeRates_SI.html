<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Frieda">

<title>Relative_Transitions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="2_RelativeRates_SI_files/libs/clipboard/clipboard.min.js"></script>
<script src="2_RelativeRates_SI_files/libs/quarto-html/quarto.js"></script>
<script src="2_RelativeRates_SI_files/libs/quarto-html/popper.min.js"></script>
<script src="2_RelativeRates_SI_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="2_RelativeRates_SI_files/libs/quarto-html/anchor.min.js"></script>
<link href="2_RelativeRates_SI_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="2_RelativeRates_SI_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="2_RelativeRates_SI_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="2_RelativeRates_SI_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="2_RelativeRates_SI_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Relative_Transitions</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Frieda </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="required-libraries" class="level1">
<h1>0. Required Libraries</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean environment:</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Libraries:</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(phangorn) <span class="co"># to compute MCC tree</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: ape</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(evobiR) <span class="co"># reorder data by tree</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'evobiR'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:phangorn':

    AICc</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(phytools) <span class="co"># v. ‘1.9.16’ for phylo stuff</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: maps</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr) <span class="co"># for data handling</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:ape':

    where</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(evobiR) <span class="co"># v. ‘1.1’ To reorder data based on tree</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geiger) <span class="co"># v. ‘2.0.11’ for Mk Models</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tictoc) <span class="co"># for time measurements of computations</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr) <span class="co"># data handling</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2) </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(prettyGraphs) <span class="co"># for transparancy settings while plotting</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="in-script-1_cumulativerates.qmd" class="level1">
<h1>1. &amp; 2. in Script: 1_CumulativeRates.qmd</h1>
<section id="a-legumes" class="level2">
<h2 class="anchored" data-anchor-id="a-legumes">A) Legumes</h2>
</section>
</section>
<section id="relative-transition-rates" class="level1">
<h1>3. Relative Transition rates</h1>
<p>this part runs a while.. the loop takes about 22 minutes.</p>
<section id="adaptation-of-ctt-function-in-loop-save-to-list" class="level2">
<h2 class="anchored" data-anchor-id="adaptation-of-ctt-function-in-loop-save-to-list">Adaptation of ctt function (in loop, save to list)</h2>
<p>Reference: <a href="https://github.com/liamrevell/phytools/blob/master/R/ctt.R">ctt.R</a> (Phytools package)</p>
<pre><code>&gt; packageVersion("phytools") [1] ‘1.9.16’</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>( <span class="st">"loop"</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>mtrees <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../output/RDS/legumes_mtrees_multiSimmap.rds"</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="do">### Required function ========================================================================== #</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>getChanges<span class="ot">&lt;-</span><span class="cf">function</span>(tree){</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  states<span class="ot">&lt;-</span><span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">getStates</span>(tree)))</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  nc<span class="ot">&lt;-</span><span class="fu">sapply</span>(tree<span class="sc">$</span>maps,length)<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  b<span class="ot">&lt;-</span><span class="fu">which</span>(nc<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  nc<span class="ot">&lt;-</span>nc[b]</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  xx<span class="ot">&lt;-</span><span class="fu">vector</span>()</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  H<span class="ot">&lt;-</span><span class="fu">nodeHeights</span>(tree)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(b)){</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nc[i]){</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>      ss<span class="ot">&lt;-</span><span class="fu">names</span>(tree<span class="sc">$</span>maps[[b[i]]])[j<span class="sc">+</span><span class="dv">1</span>]</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>      x<span class="ot">&lt;-</span><span class="fu">rep</span>(H[b[i],<span class="dv">1</span>]<span class="sc">+</span><span class="fu">cumsum</span>(tree<span class="sc">$</span>maps[[b[i]]])[j],<span class="dv">2</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>      xx<span class="ot">&lt;-</span><span class="fu">c</span>(xx,<span class="fu">setNames</span>(x[<span class="dv">1</span>],</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">paste</span>(<span class="fu">names</span>(tree<span class="sc">$</span>maps[[b[i]]])[j<span class="sc">:</span>(j<span class="sc">+</span><span class="dv">1</span>)],</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>                              <span class="at">collapse=</span><span class="st">"-&gt;"</span>)))</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  xx</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================================= #</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a function to find the segment ID for a given time value:</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================================= #</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>find_segment_id <span class="ot">&lt;-</span> <span class="cf">function</span>(time) {</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  segment_indices <span class="ot">&lt;-</span> <span class="fu">cut</span>(time, <span class="at">breaks =</span> segs_df[, <span class="dv">2</span>], <span class="at">labels =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(segs_df<span class="sc">$</span>segsID[segment_indices])</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a><span class="do">## ============================================================================================= #</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ================================================================= #</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Working the multiSiammp</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ================================================================= #</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get all changes from all simulations so that we can loop through them:</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>  changes <span class="ot">&lt;-</span> <span class="fu">sapply</span>(mtrees, getChanges) </span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transform the original changes list of matrices from sapply() for all simulations to dataframe </span></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add trans_no to each transition based on grouping by transition </span></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (i.e, there are two trans_no = 1, one for each transition type)</span></span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>  i_changes_list <span class="ot">&lt;-</span> <span class="fu">list</span>() </span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(changes)) {</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>    i_changes <span class="ot">&lt;-</span> changes[[i]] <span class="co"># for each simulation from multiSimmap</span></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># extract transition types and times and assign ID column for simmap simulation</span></span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>    i_changes_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">transition =</span> <span class="fu">names</span>(i_changes), <span class="at">time =</span> i_changes, <span class="at">N_sim =</span> i)</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>    i_changes_df<span class="sc">$</span>transition <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(i_changes_df<span class="sc">$</span>transition)</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add trans_no to each transition from a group (transition type)</span></span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>    i_changes_df <span class="ot">&lt;-</span> i_changes_df <span class="sc">%&gt;%</span>  <span class="fu">arrange</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(transition) <span class="sc">%&gt;%</span></span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">trans_no =</span> <span class="fu">row_number</span>())</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>    i_changes_list[[i]] <span class="ot">&lt;-</span> i_changes_df</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Final Table without edge.lengths:</span></span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>  changes_table <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">rbind.fill</span>(i_changes_list, <span class="at">fill=</span>T)</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>  changes_table_wo_edge <span class="ot">&lt;-</span> changes_table</span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a><span class="co"># ====================================================================================================== #</span></span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a><span class="do">## Step 1: Loop over each simulation and extract </span></span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a><span class="co"># - breaks for segments</span></span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a><span class="co"># - edge.lengths</span></span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a><span class="co"># - rates for each character state transition</span></span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a><span class="co"># ====================================================================================================== #</span></span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a>object_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a>rates_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a><span class="co"># First Level of the loop  </span></span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (Nsimulation <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>){ </span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ====================================================================================================== #</span></span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Setting global variables for the Analysis</span></span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ====================================================================================================== #</span></span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set the number of time-segments for which everything will be calculated:</span></span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">&lt;-</span> <span class="dv">20</span>    </span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reduce to one tree to extract parameters from each simulation separately:</span></span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a>  tree <span class="ot">&lt;-</span> <span class="fu">as.phylo</span>(mtrees[[Nsimulation]])</span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-105"><a href="#cb15-105" aria-hidden="true" tabindex="-1"></a>  <span class="co"># extract time since root</span></span>
<span id="cb15-106"><a href="#cb15-106" aria-hidden="true" tabindex="-1"></a>  h <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">nodeHeights</span>(tree))</span>
<span id="cb15-107"><a href="#cb15-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-108"><a href="#cb15-108" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate the time segments based on time since the origin and the time segments that were set by the user</span></span>
<span id="cb15-109"><a href="#cb15-109" aria-hidden="true" tabindex="-1"></a>  segs <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">seq</span>(<span class="dv">0</span>,h<span class="sc">-</span>h<span class="sc">/</span>b,h<span class="sc">/</span>b),</span>
<span id="cb15-110"><a href="#cb15-110" aria-hidden="true" tabindex="-1"></a>              <span class="fu">seq</span>(<span class="dv">1</span><span class="sc">/</span>b<span class="sc">*</span>h,h,h<span class="sc">/</span>b))</span>
<span id="cb15-111"><a href="#cb15-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-112"><a href="#cb15-112" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-113"><a href="#cb15-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ====================================================================================================== #</span></span>
<span id="cb15-114"><a href="#cb15-114" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transitions &amp; Timing  (getChanges)</span></span>
<span id="cb15-115"><a href="#cb15-115" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ====================================================================================================== #</span></span>
<span id="cb15-116"><a href="#cb15-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-117"><a href="#cb15-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-118"><a href="#cb15-118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ================================================================= #</span></span>
<span id="cb15-119"><a href="#cb15-119" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Working changes from each simmap simulation separately:</span></span>
<span id="cb15-120"><a href="#cb15-120" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ----------------------------------------------------------------- #</span></span>
<span id="cb15-121"><a href="#cb15-121" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Changes per Segments:</span></span>
<span id="cb15-122"><a href="#cb15-122" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ================================================================= #</span></span>
<span id="cb15-123"><a href="#cb15-123" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-124"><a href="#cb15-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-125"><a href="#cb15-125" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through all changes &amp; Calculate average number of changes per time interval (segs; set with "b")</span></span>
<span id="cb15-126"><a href="#cb15-126" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-127"><a href="#cb15-127" aria-hidden="true" tabindex="-1"></a>  nchanges<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="dv">0</span>,b)</span>
<span id="cb15-128"><a href="#cb15-128" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(changes)) { <span class="co"># loop through all simulations from simmap  </span></span>
<span id="cb15-129"><a href="#cb15-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-130"><a href="#cb15-130" aria-hidden="true" tabindex="-1"></a><span class="co"># loop through all individual changes from one simmap simulation and calculate relative changes per time segment</span></span>
<span id="cb15-131"><a href="#cb15-131" aria-hidden="true" tabindex="-1"></a><span class="co"># nchanges = collects the relative number of changes (of all changes) per segment</span></span>
<span id="cb15-132"><a href="#cb15-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-133"><a href="#cb15-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(changes[[i]])) { </span>
<span id="cb15-134"><a href="#cb15-134" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb15-135"><a href="#cb15-135" aria-hidden="true" tabindex="-1"></a>      ind<span class="ot">&lt;-</span><span class="fu">which</span>((changes[[i]][j]<span class="sc">&gt;</span>segs[,<span class="dv">1</span>])<span class="sc">+</span> </span>
<span id="cb15-136"><a href="#cb15-136" aria-hidden="true" tabindex="-1"></a>                   (changes[[i]][j]<span class="sc">&lt;=</span>segs[,<span class="dv">2</span>])<span class="sc">==</span><span class="dv">2</span>)</span>
<span id="cb15-137"><a href="#cb15-137" aria-hidden="true" tabindex="-1"></a>      nchanges[ind]<span class="ot">&lt;-</span>nchanges[ind]<span class="sc">+</span><span class="dv">1</span><span class="sc">/</span><span class="fu">length</span>(changes)</span>
<span id="cb15-138"><a href="#cb15-138" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb15-139"><a href="#cb15-139" aria-hidden="true" tabindex="-1"></a>      } <span class="co"># closing of 2nd level</span></span>
<span id="cb15-140"><a href="#cb15-140" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-141"><a href="#cb15-141" aria-hidden="true" tabindex="-1"></a>    } <span class="co"># closing of 1st level</span></span>
<span id="cb15-142"><a href="#cb15-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-143"><a href="#cb15-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(i,j)  </span>
<span id="cb15-144"><a href="#cb15-144" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-145"><a href="#cb15-145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-146"><a href="#cb15-146" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ================================================================= #</span></span>
<span id="cb15-147"><a href="#cb15-147" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Working changes from each simmap simulation separately:</span></span>
<span id="cb15-148"><a href="#cb15-148" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ----------------------------------------------------------------- #</span></span>
<span id="cb15-149"><a href="#cb15-149" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Edge Lengths per Segments:</span></span>
<span id="cb15-150"><a href="#cb15-150" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ================================================================= #</span></span>
<span id="cb15-151"><a href="#cb15-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-152"><a href="#cb15-152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Edge.Lengths = Number of species in the phylogeny per time slot (increases naturally with time)</span></span>
<span id="cb15-153"><a href="#cb15-153" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ! Note: has to be accounted for when showing transition rates</span></span>
<span id="cb15-154"><a href="#cb15-154" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Here we calculate edge lengths for each segement separatly:</span></span>
<span id="cb15-155"><a href="#cb15-155" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-156"><a href="#cb15-156" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -------------------------------------------------------------------------------------------------------- #</span></span>
<span id="cb15-157"><a href="#cb15-157" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-158"><a href="#cb15-158" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute Lineages-Through-Time with ltt() function from the phytools package to extract edge.lengths from</span></span>
<span id="cb15-159"><a href="#cb15-159" aria-hidden="true" tabindex="-1"></a>  LTT <span class="ot">&lt;-</span> <span class="fu">ltt</span>(tree,<span class="at">plot=</span><span class="cn">FALSE</span>)</span>
<span id="cb15-160"><a href="#cb15-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-161"><a href="#cb15-161" aria-hidden="true" tabindex="-1"></a>    <span class="co"># transform LTT data so that we can use it:</span></span>
<span id="cb15-162"><a href="#cb15-162" aria-hidden="true" tabindex="-1"></a>  LTT <span class="ot">&lt;-</span> <span class="fu">cbind</span>(LTT<span class="sc">$</span>ltt[<span class="dv">2</span><span class="sc">:</span>(<span class="fu">length</span>(LTT<span class="sc">$</span>ltt)<span class="sc">-</span><span class="dv">1</span>)],            <span class="co"># Number of species at each node minus the root</span></span>
<span id="cb15-163"><a href="#cb15-163" aria-hidden="true" tabindex="-1"></a>               LTT<span class="sc">$</span>times[<span class="dv">2</span><span class="sc">:</span>(<span class="fu">length</span>(LTT<span class="sc">$</span>ltt)<span class="sc">-</span><span class="dv">1</span>)],          <span class="co"># "start" time for each node minus the root</span></span>
<span id="cb15-164"><a href="#cb15-164" aria-hidden="true" tabindex="-1"></a>               LTT<span class="sc">$</span>times[<span class="dv">3</span><span class="sc">:</span><span class="fu">length</span>(LTT<span class="sc">$</span>ltt)])              <span class="co"># "end" time for each node minus the root</span></span>
<span id="cb15-165"><a href="#cb15-165" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-166"><a href="#cb15-166" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -------------------------------------------------------------------------------------------------#</span></span>
<span id="cb15-167"><a href="#cb15-167" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-168"><a href="#cb15-168" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Now we loop through all segments to extract matching edge.lengths =================================== #</span></span>
<span id="cb15-169"><a href="#cb15-169" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-170"><a href="#cb15-170" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set count variable:</span></span>
<span id="cb15-171"><a href="#cb15-171" aria-hidden="true" tabindex="-1"></a>    ii<span class="ot">&lt;-</span><span class="dv">1</span></span>
<span id="cb15-172"><a href="#cb15-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-173"><a href="#cb15-173" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create an empty vector to store edge lengths</span></span>
<span id="cb15-174"><a href="#cb15-174" aria-hidden="true" tabindex="-1"></a>    edge.length <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(segs))</span>
<span id="cb15-175"><a href="#cb15-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-176"><a href="#cb15-176" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-177"><a href="#cb15-177" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2nd level loop: </span></span>
<span id="cb15-178"><a href="#cb15-178" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (for one tree because LTT is calculated for one tree)</span></span>
<span id="cb15-179"><a href="#cb15-179" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> (i_segs <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(segs)) {</span>
<span id="cb15-180"><a href="#cb15-180" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb15-181"><a href="#cb15-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-182"><a href="#cb15-182" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Find the indices of LTT segments that overlap with the current segs segment</span></span>
<span id="cb15-183"><a href="#cb15-183" aria-hidden="true" tabindex="-1"></a>     overlap_indices <span class="ot">&lt;-</span> <span class="fu">which</span>(LTT[, <span class="dv">2</span>] <span class="sc">&lt;=</span> segs[i_segs, <span class="dv">2</span>] <span class="sc">&amp;</span> LTT[, <span class="dv">3</span>] <span class="sc">&gt;=</span> segs[i_segs, <span class="dv">1</span>])</span>
<span id="cb15-184"><a href="#cb15-184" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-185"><a href="#cb15-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-186"><a href="#cb15-186" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Calculate edge length for the current segs segment using vectorized operations</span></span>
<span id="cb15-187"><a href="#cb15-187" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 3rd level loop: </span></span>
<span id="cb15-188"><a href="#cb15-188" aria-hidden="true" tabindex="-1"></a>     <span class="cf">for</span> (ii <span class="cf">in</span> overlap_indices) {</span>
<span id="cb15-189"><a href="#cb15-189" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb15-190"><a href="#cb15-190" aria-hidden="true" tabindex="-1"></a>       <span class="co"># edge.length should contain the edge lengths for all segments:  </span></span>
<span id="cb15-191"><a href="#cb15-191" aria-hidden="true" tabindex="-1"></a>       edge.length[i_segs] <span class="ot">&lt;-</span> edge.length[i_segs] <span class="sc">+</span>        </span>
<span id="cb15-192"><a href="#cb15-192" aria-hidden="true" tabindex="-1"></a>         LTT[ii, <span class="dv">1</span>] <span class="sc">*</span> <span class="co"># counts number of lineages between time intervals</span></span>
<span id="cb15-193"><a href="#cb15-193" aria-hidden="true" tabindex="-1"></a>         (<span class="fu">min</span>(segs[i_segs, <span class="dv">2</span>], LTT[ii, <span class="dv">3</span>]) <span class="sc">-</span> <span class="co"># end time interval</span></span>
<span id="cb15-194"><a href="#cb15-194" aria-hidden="true" tabindex="-1"></a>            <span class="fu">max</span>(segs[i_segs, <span class="dv">1</span>], LTT[ii, <span class="dv">2</span>]))  <span class="co"># start time interval</span></span>
<span id="cb15-195"><a href="#cb15-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-196"><a href="#cb15-196" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb15-197"><a href="#cb15-197" aria-hidden="true" tabindex="-1"></a>       } <span class="co"># 3rd level closing</span></span>
<span id="cb15-198"><a href="#cb15-198" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb15-199"><a href="#cb15-199" aria-hidden="true" tabindex="-1"></a>   } <span class="co"># 2nd level closing</span></span>
<span id="cb15-200"><a href="#cb15-200" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-201"><a href="#cb15-201" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-202"><a href="#cb15-202" aria-hidden="true" tabindex="-1"></a>    edge.length_backup <span class="ot">&lt;-</span> edge.length</span>
<span id="cb15-203"><a href="#cb15-203" aria-hidden="true" tabindex="-1"></a>    edge.length <span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">1</span>, edge.length)</span>
<span id="cb15-204"><a href="#cb15-204" aria-hidden="true" tabindex="-1"></a>  <span class="co"># edge.length should contain the edge lengths for all segments in a given simulation</span></span>
<span id="cb15-205"><a href="#cb15-205" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-206"><a href="#cb15-206" aria-hidden="true" tabindex="-1"></a>    <span class="co"># adding segsID coulmn to edge lengths:</span></span>
<span id="cb15-207"><a href="#cb15-207" aria-hidden="true" tabindex="-1"></a>    edge.length_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">edge.length =</span> edge.length, <span class="at">segsID =</span> <span class="fu">seq</span>(<span class="dv">1</span>,b<span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb15-208"><a href="#cb15-208" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-209"><a href="#cb15-209" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-210"><a href="#cb15-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-211"><a href="#cb15-211" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ================================================================= #</span></span>
<span id="cb15-212"><a href="#cb15-212" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Working the multiSimmap:</span></span>
<span id="cb15-213"><a href="#cb15-213" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ----------------------------------------------------------------- #</span></span>
<span id="cb15-214"><a href="#cb15-214" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Edge Lengths at each transition event</span></span>
<span id="cb15-215"><a href="#cb15-215" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ================================================================= #</span></span>
<span id="cb15-216"><a href="#cb15-216" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Adapted code from the segments (above) by Frieda</span></span>
<span id="cb15-217"><a href="#cb15-217" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-218"><a href="#cb15-218" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we need the table for all simmaps: changes_table so that we can loop through it</span></span>
<span id="cb15-219"><a href="#cb15-219" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-220"><a href="#cb15-220" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set count variable:</span></span>
<span id="cb15-221"><a href="#cb15-221" aria-hidden="true" tabindex="-1"></a>    ii<span class="ot">&lt;-</span><span class="dv">1</span></span>
<span id="cb15-222"><a href="#cb15-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-223"><a href="#cb15-223" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create an empty vector to store edge lengths</span></span>
<span id="cb15-224"><a href="#cb15-224" aria-hidden="true" tabindex="-1"></a>    edge.length_transitions <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(changes_table))</span>
<span id="cb15-225"><a href="#cb15-225" aria-hidden="true" tabindex="-1"></a>  edge.lengths_all <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb15-226"><a href="#cb15-226" aria-hidden="true" tabindex="-1"></a>    changes_times <span class="ot">&lt;-</span> changes_table<span class="sc">$</span>time</span>
<span id="cb15-227"><a href="#cb15-227" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-228"><a href="#cb15-228" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-229"><a href="#cb15-229" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2nd level loop: </span></span>
<span id="cb15-230"><a href="#cb15-230" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (for one tree because LTT is calculated for one tree)</span></span>
<span id="cb15-231"><a href="#cb15-231" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> (i_changes <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(changes_table)) {</span>
<span id="cb15-232"><a href="#cb15-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-233"><a href="#cb15-233" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Find the indices of LTT segments that overlap with the current segs segment</span></span>
<span id="cb15-234"><a href="#cb15-234" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb15-235"><a href="#cb15-235" aria-hidden="true" tabindex="-1"></a>     <span class="co"># "which start times of the Lineages are smaller or equal to the time the change happened and which end times of the lineages are larger or equal to the time the change happend."</span></span>
<span id="cb15-236"><a href="#cb15-236" aria-hidden="true" tabindex="-1"></a>     <span class="co"># --&gt; this gives the node numbers that were there when the transition happend</span></span>
<span id="cb15-237"><a href="#cb15-237" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb15-238"><a href="#cb15-238" aria-hidden="true" tabindex="-1"></a>     overlap_indices <span class="ot">&lt;-</span> <span class="fu">which</span>(LTT[, <span class="dv">2</span>] <span class="sc">&lt;=</span> changes_times[i_changes] <span class="sc">&amp;</span> LTT[, <span class="dv">3</span>] <span class="sc">&gt;=</span> changes_times[i_changes])</span>
<span id="cb15-239"><a href="#cb15-239" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-240"><a href="#cb15-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-241"><a href="#cb15-241" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Calculate edge length for the current segs segment using vectorized operations</span></span>
<span id="cb15-242"><a href="#cb15-242" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 3rd level loop: </span></span>
<span id="cb15-243"><a href="#cb15-243" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb15-244"><a href="#cb15-244" aria-hidden="true" tabindex="-1"></a>     <span class="cf">for</span> (ii <span class="cf">in</span> overlap_indices) { <span class="co"># ii = number of lineages when a transition occurred</span></span>
<span id="cb15-245"><a href="#cb15-245" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb15-246"><a href="#cb15-246" aria-hidden="true" tabindex="-1"></a>       <span class="co"># edge.length should contain the edge lengths for all segments:  </span></span>
<span id="cb15-247"><a href="#cb15-247" aria-hidden="true" tabindex="-1"></a>       edge.length_transitions[i_changes] <span class="ot">&lt;-</span> edge.length_transitions[i_changes] <span class="sc">+</span>        </span>
<span id="cb15-248"><a href="#cb15-248" aria-hidden="true" tabindex="-1"></a>         LTT[ii, <span class="dv">1</span>] </span>
<span id="cb15-249"><a href="#cb15-249" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb15-250"><a href="#cb15-250" aria-hidden="true" tabindex="-1"></a>       edge.length_transitions2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> changes_times[i_changes], <span class="at">edge.length =</span> edge.length_transitions[i_changes])</span>
<span id="cb15-251"><a href="#cb15-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-252"><a href="#cb15-252" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb15-253"><a href="#cb15-253" aria-hidden="true" tabindex="-1"></a>       edge.lengths_all[[i_changes]] <span class="ot">&lt;-</span> edge.length_transitions2</span>
<span id="cb15-254"><a href="#cb15-254" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb15-255"><a href="#cb15-255" aria-hidden="true" tabindex="-1"></a>       } <span class="co"># 3rd level closing</span></span>
<span id="cb15-256"><a href="#cb15-256" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb15-257"><a href="#cb15-257" aria-hidden="true" tabindex="-1"></a>   } <span class="co"># 2nd level closing</span></span>
<span id="cb15-258"><a href="#cb15-258" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-259"><a href="#cb15-259" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-260"><a href="#cb15-260" aria-hidden="true" tabindex="-1"></a>  edge.lengths_all_df <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">rbind.fill</span>(edge.lengths_all)</span>
<span id="cb15-261"><a href="#cb15-261" aria-hidden="true" tabindex="-1"></a>  changes_table_w_edge <span class="ot">&lt;-</span> <span class="fu">merge</span>(changes_table_wo_edge, edge.lengths_all_df, <span class="at">by =</span> <span class="st">"time"</span>)</span>
<span id="cb15-262"><a href="#cb15-262" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Write to file (once is enough)</span></span>
<span id="cb15-263"><a href="#cb15-263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(changes_table_w_edge, <span class="st">"../output/CSV/Legumes_changes_table_w_edgelengths.csv"</span>)</span>
<span id="cb15-264"><a href="#cb15-264" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-265"><a href="#cb15-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-266"><a href="#cb15-266" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================================= #</span></span>
<span id="cb15-267"><a href="#cb15-267" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a dataframe with transitions, times, edge.lengths, segment IDs.</span></span>
<span id="cb15-268"><a href="#cb15-268" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================================= #</span></span>
<span id="cb15-269"><a href="#cb15-269" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb15-270"><a href="#cb15-270" aria-hidden="true" tabindex="-1"></a>  <span class="do">## We are here = first level loop: along simulations</span></span>
<span id="cb15-271"><a href="#cb15-271" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb15-272"><a href="#cb15-272" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Again extract changes for each simulation separately:</span></span>
<span id="cb15-273"><a href="#cb15-273" aria-hidden="true" tabindex="-1"></a>      current_simulation <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(changes[[Nsimulation]], </span>
<span id="cb15-274"><a href="#cb15-274" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">row.names =</span> <span class="fu">names</span>(changes[[Nsimulation]]))</span>
<span id="cb15-275"><a href="#cb15-275" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(current_simulation) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"time"</span>)</span>
<span id="cb15-276"><a href="#cb15-276" aria-hidden="true" tabindex="-1"></a>      current_simulation<span class="sc">$</span>transition <span class="ot">&lt;-</span> <span class="fu">rownames</span>(current_simulation)</span>
<span id="cb15-277"><a href="#cb15-277" aria-hidden="true" tabindex="-1"></a>        current_simulation<span class="sc">$</span>N_sim <span class="ot">&lt;-</span> Nsimulation</span>
<span id="cb15-278"><a href="#cb15-278" aria-hidden="true" tabindex="-1"></a>        current_simulation <span class="ot">&lt;-</span> current_simulation <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(time)</span>
<span id="cb15-279"><a href="#cb15-279" aria-hidden="true" tabindex="-1"></a>        current_simulation<span class="sc">$</span>IDtransition <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(current_simulation))</span>
<span id="cb15-280"><a href="#cb15-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-281"><a href="#cb15-281" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-282"><a href="#cb15-282" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ============================================================================================= #</span></span>
<span id="cb15-283"><a href="#cb15-283" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Working the segments: </span></span>
<span id="cb15-284"><a href="#cb15-284" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ============================================================================================= #</span></span>
<span id="cb15-285"><a href="#cb15-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-286"><a href="#cb15-286" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-287"><a href="#cb15-287" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a vector of segment IDs</span></span>
<span id="cb15-288"><a href="#cb15-288" aria-hidden="true" tabindex="-1"></a>        segs_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(segs)</span>
<span id="cb15-289"><a href="#cb15-289" aria-hidden="true" tabindex="-1"></a>        new_row <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">V1 =</span> <span class="dv">0</span>, <span class="at">V2 =</span> <span class="dv">0</span>) <span class="co"># add a row that starts from 0 and ends with 0.. we need this later on for plotting</span></span>
<span id="cb15-290"><a href="#cb15-290" aria-hidden="true" tabindex="-1"></a>        segs_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(new_row, segs_df)</span>
<span id="cb15-291"><a href="#cb15-291" aria-hidden="true" tabindex="-1"></a>        segs_df<span class="sc">$</span>segsID <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>,b<span class="sc">+</span><span class="dv">1</span>) <span class="co"># now we can calculate the breaks from it</span></span>
<span id="cb15-292"><a href="#cb15-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-293"><a href="#cb15-293" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use the apply function to find the segment ID for each row in current_simulation</span></span>
<span id="cb15-294"><a href="#cb15-294" aria-hidden="true" tabindex="-1"></a>        current_simulation<span class="sc">$</span>segsID <span class="ot">&lt;-</span> <span class="fu">apply</span>(current_simulation, <span class="dv">1</span>, <span class="cf">function</span>(row) {</span>
<span id="cb15-295"><a href="#cb15-295" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-296"><a href="#cb15-296" aria-hidden="true" tabindex="-1"></a>          time <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(row[<span class="st">"time"</span>])</span>
<span id="cb15-297"><a href="#cb15-297" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="fu">find_segment_id</span>(time))</span>
<span id="cb15-298"><a href="#cb15-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-299"><a href="#cb15-299" aria-hidden="true" tabindex="-1"></a>          }) <span class="co"># closing loop from within the apply-function (2nd level loop closing)</span></span>
<span id="cb15-300"><a href="#cb15-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-301"><a href="#cb15-301" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-302"><a href="#cb15-302" aria-hidden="true" tabindex="-1"></a>        <span class="co"># assign edge.length based on segment ID</span></span>
<span id="cb15-303"><a href="#cb15-303" aria-hidden="true" tabindex="-1"></a>        current_simulation <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">merge</span>(current_simulation, edge.length_df, <span class="at">by=</span><span class="st">"segsID"</span>, <span class="at">all =</span> T))</span>
<span id="cb15-304"><a href="#cb15-304" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(segs_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"segs_start"</span>, <span class="st">"segs_end"</span>, <span class="st">"segsID"</span>)</span>
<span id="cb15-305"><a href="#cb15-305" aria-hidden="true" tabindex="-1"></a>      current_simulation <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">merge</span>(current_simulation, segs_df, <span class="at">by =</span> <span class="st">"segsID"</span>, <span class="at">all =</span> T))</span>
<span id="cb15-306"><a href="#cb15-306" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-307"><a href="#cb15-307" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculate rate for each simulation:</span></span>
<span id="cb15-308"><a href="#cb15-308" aria-hidden="true" tabindex="-1"></a>        current_simulation_rates <span class="ot">&lt;-</span> current_simulation <span class="sc">%&gt;%</span> </span>
<span id="cb15-309"><a href="#cb15-309" aria-hidden="true" tabindex="-1"></a>          <span class="fu">group_by</span>(segsID, N_sim, transition) <span class="sc">%&gt;%</span> </span>
<span id="cb15-310"><a href="#cb15-310" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">Nchanges =</span> <span class="fu">length</span>(<span class="sc">!</span><span class="fu">is.na</span>(IDtransition))) <span class="sc">%&gt;%</span> </span>
<span id="cb15-311"><a href="#cb15-311" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">rate =</span> Nchanges <span class="sc">/</span> edge.length)</span>
<span id="cb15-312"><a href="#cb15-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-313"><a href="#cb15-313" aria-hidden="true" tabindex="-1"></a>     rates_list[[Nsimulation]] <span class="ot">&lt;-</span> current_simulation_rates <span class="co"># we need the rates_list object for plotting (!)</span></span>
<span id="cb15-314"><a href="#cb15-314" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb15-315"><a href="#cb15-315" aria-hidden="true" tabindex="-1"></a>     object <span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">segments=</span>segs, </span>
<span id="cb15-316"><a href="#cb15-316" aria-hidden="true" tabindex="-1"></a>                   <span class="at">nchanges=</span>nchanges, </span>
<span id="cb15-317"><a href="#cb15-317" aria-hidden="true" tabindex="-1"></a>                   <span class="at">edge.length=</span>edge.length[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb15-318"><a href="#cb15-318" aria-hidden="true" tabindex="-1"></a>                   <span class="at">tree=</span>tree)</span>
<span id="cb15-319"><a href="#cb15-319" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb15-320"><a href="#cb15-320" aria-hidden="true" tabindex="-1"></a>    <span class="fu">class</span>(object)<span class="ot">&lt;-</span><span class="st">"ctt"</span></span>
<span id="cb15-321"><a href="#cb15-321" aria-hidden="true" tabindex="-1"></a>    object_list[[Nsimulation]] <span class="ot">&lt;-</span> object </span>
<span id="cb15-322"><a href="#cb15-322" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb15-323"><a href="#cb15-323" aria-hidden="true" tabindex="-1"></a>} <span class="co"># 1st level closing</span></span>
<span id="cb15-324"><a href="#cb15-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-325"><a href="#cb15-325" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()  <span class="co"># 1218.6 sec elapsed = 20.3 min</span></span>
<span id="cb15-326"><a href="#cb15-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-327"><a href="#cb15-327" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(object_list) <span class="ot">&lt;-</span><span class="st">"multiCtt"</span></span>
<span id="cb15-328"><a href="#cb15-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-329"><a href="#cb15-329" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------- #</span></span>
<span id="cb15-330"><a href="#cb15-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-331"><a href="#cb15-331" aria-hidden="true" tabindex="-1"></a><span class="co"># Make dataframe with rates from the rates_list object for all simulations from the simmap:</span></span>
<span id="cb15-332"><a href="#cb15-332" aria-hidden="true" tabindex="-1"></a>rates_df <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">rbind.fill</span>(rates_list)</span>
<span id="cb15-333"><a href="#cb15-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-334"><a href="#cb15-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-335"><a href="#cb15-335" aria-hidden="true" tabindex="-1"></a><span class="co"># Now set columns: rates, Nchanges to 0 if there was no transition</span></span>
<span id="cb15-336"><a href="#cb15-336" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the average transition time based on numbered transitions from 100 simmap simulations</span></span>
<span id="cb15-337"><a href="#cb15-337" aria-hidden="true" tabindex="-1"></a><span class="co"># set average timing of 0-transition to mean-segment time </span></span>
<span id="cb15-338"><a href="#cb15-338" aria-hidden="true" tabindex="-1"></a><span class="co"># then order the dataframe by segment ID:</span></span>
<span id="cb15-339"><a href="#cb15-339" aria-hidden="true" tabindex="-1"></a>rates_df <span class="ot">&lt;-</span> rates_df <span class="sc">%&gt;%</span></span>
<span id="cb15-340"><a href="#cb15-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(N_sim, segsID, transition) <span class="sc">%&gt;%</span></span>
<span id="cb15-341"><a href="#cb15-341" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-342"><a href="#cb15-342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(transition), <span class="dv">0</span>, rate), <span class="co"># set transition rates 0 if there was no transition</span></span>
<span id="cb15-343"><a href="#cb15-343" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb15-344"><a href="#cb15-344" aria-hidden="true" tabindex="-1"></a>         <span class="at">Nchanges =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(transition), <span class="dv">0</span>, Nchanges), <span class="co"># set Nchanges 0 if there was no transition</span></span>
<span id="cb15-345"><a href="#cb15-345" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb15-346"><a href="#cb15-346" aria-hidden="true" tabindex="-1"></a>         <span class="at">segs_mean =</span> (segs_end<span class="sc">+</span> segs_start)<span class="sc">/</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="co"># Adjust the threshold (1e-6) as needed</span></span>
<span id="cb15-347"><a href="#cb15-347" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-348"><a href="#cb15-348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">avg_time =</span> <span class="fu">ifelse</span>(Nchanges <span class="sc">==</span> <span class="dv">1</span>, time, <span class="fu">mean</span>(time))) <span class="sc">%&gt;%</span>  <span class="co"># set average time = time if there was only 1 change</span></span>
<span id="cb15-349"><a href="#cb15-349" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-350"><a href="#cb15-350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">avg_time =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(avg_time), segs_mean, avg_time)) <span class="sc">%&gt;%</span> <span class="co"># set time to mean time bin if there was no transition</span></span>
<span id="cb15-351"><a href="#cb15-351" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-352"><a href="#cb15-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(segsID) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() </span>
<span id="cb15-353"><a href="#cb15-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-354"><a href="#cb15-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-355"><a href="#cb15-355" aria-hidden="true" tabindex="-1"></a><span class="fu">save.image</span>(<span class="st">"~/GitHub/Evo-Legumes-Herbivory/LegumesArmature/output/RData/Legumes_rates_ws.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This now gives us the object “object_list”, which can be used inside the phytools function plot.multiCtt() to get the overall increases and decreases for the rates (not separated by each rate). We can also plot the rates of each simulation separately using plot.ctt() from phytools Also, we have just created the rates_df for plotting</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../output/RData/Legumes_rates_ws.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plot.multictt" class="level2">
<h2 class="anchored" data-anchor-id="plot.multictt">plot.multiCtt()</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>plot.multiCtt<span class="ot">&lt;-</span><span class="cf">function</span>(x,...){</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">hasArg</span>(alpha)) alpha<span class="ot">&lt;-</span><span class="fu">list</span>(...)<span class="sc">$</span>alpha</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> alpha<span class="ot">&lt;-</span><span class="fl">0.05</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  segments<span class="ot">&lt;-</span>x[[<span class="dv">1</span>]]<span class="sc">$</span>segments</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  nchanges<span class="ot">&lt;-</span><span class="fu">sapply</span>(x,<span class="cf">function</span>(x) x<span class="sc">$</span>nchanges)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">hasArg</span>(type)) type<span class="ot">&lt;-</span><span class="fu">list</span>(...)<span class="sc">$</span>type</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> type<span class="ot">&lt;-</span><span class="st">"rate"</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  edge.length<span class="ot">&lt;-</span><span class="fu">sapply</span>(x,<span class="cf">function</span>(x) x<span class="sc">$</span>edge.length)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  obj<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">segments=</span>segments,<span class="at">nchanges=</span><span class="fu">rowMeans</span>(nchanges),</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">edge.length=</span><span class="fu">rowMeans</span>(edge.length),<span class="at">tree=</span>x[[<span class="dv">1</span>]]<span class="sc">$</span>tree)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class</span>(obj)<span class="ot">&lt;-</span><span class="st">"ctt"</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  lower<span class="ot">&lt;-</span><span class="fu">max</span>(<span class="fu">floor</span>(alpha<span class="sc">/</span><span class="dv">2</span><span class="sc">*</span><span class="fu">length</span>(x)),<span class="dv">1</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  upper<span class="ot">&lt;-</span><span class="fu">min</span>(<span class="fu">ceiling</span>((<span class="dv">1</span><span class="sc">-</span>alpha<span class="sc">/</span><span class="dv">2</span>)<span class="sc">*</span><span class="fu">length</span>(x)),<span class="fu">ncol</span>(nchanges))</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  xx<span class="ot">&lt;-</span><span class="fu">max</span>(<span class="fu">nodeHeights</span>(x[[<span class="dv">1</span>]]<span class="sc">$</span>tree))<span class="sc">-</span><span class="fu">as.vector</span>(<span class="fu">t</span>(segments))</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  xx<span class="ot">&lt;-</span><span class="fu">c</span>(xx,xx[<span class="fu">length</span>(xx)<span class="sc">:</span><span class="dv">1</span>])</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  y.lower<span class="ot">&lt;-</span><span class="cf">if</span>(type<span class="sc">==</span><span class="st">"number"</span>) <span class="fu">apply</span>(nchanges,<span class="dv">1</span>,sort)[lower,] <span class="cf">else</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(type<span class="sc">==</span><span class="st">"rate"</span>) <span class="fu">apply</span>(nchanges<span class="sc">/</span>edge.length,<span class="dv">1</span>,sort)[lower,]</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  y.upper<span class="ot">&lt;-</span><span class="cf">if</span>(type<span class="sc">==</span><span class="st">"number"</span>) <span class="fu">apply</span>(nchanges,<span class="dv">1</span>,sort)[upper,] <span class="cf">else</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(type<span class="sc">==</span><span class="st">"rate"</span>) <span class="fu">apply</span>(nchanges<span class="sc">/</span>edge.length,<span class="dv">1</span>,sort)[upper,]</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  y.lower<span class="ot">&lt;-</span><span class="fu">as.vector</span>(<span class="fu">rbind</span>(y.lower,y.lower))</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  y.upper<span class="ot">&lt;-</span><span class="fu">as.vector</span>(<span class="fu">rbind</span>(y.upper,y.upper))</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  yy<span class="ot">&lt;-</span><span class="fu">c</span>(y.lower,y.upper[<span class="fu">length</span>(y.upper)<span class="sc">:</span><span class="dv">1</span>])</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>  args<span class="ot">&lt;-</span><span class="fu">list</span>(...)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(args<span class="sc">$</span>alpha)) args<span class="sc">$</span>alpha<span class="ot">&lt;-</span><span class="cn">NULL</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(args<span class="sc">$</span>col)) args<span class="sc">$</span>col<span class="ot">&lt;-</span><span class="st">"blue"</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(args<span class="sc">$</span>ylim)) args<span class="sc">$</span>ylim<span class="ot">&lt;-</span><span class="fu">range</span>(yy)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>  args<span class="sc">$</span>x<span class="ot">&lt;-</span>obj</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">do.call</span>(plot,args)</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">polygon</span>(xx,yy,<span class="at">col=</span><span class="fu">make.transparent</span>(<span class="st">"grey"</span>,<span class="fl">0.4</span>),<span class="at">border=</span><span class="dv">0</span>)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.multiCtt</span>(object_list, <span class="at">type=</span><span class="st">"rate"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2_RelativeRates_SI_files/figure-html/plot.multiCtt()%20function%20Legumes-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.multiCtt</span>(object_list, <span class="at">type=</span><span class="st">"number"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2_RelativeRates_SI_files/figure-html/plot.multiCtt()%20function%20Legumes-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can also plot the rates of each simulation separately using plot.ctt() from phytools:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#|label: plot.ctt() function</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>plot.ctt<span class="ot">&lt;-</span><span class="cf">function</span>(x,...){</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  h<span class="ot">&lt;-</span><span class="fu">max</span>(<span class="fu">nodeHeights</span>(x<span class="sc">$</span>tree))</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  args<span class="ot">&lt;-</span><span class="fu">list</span>(...)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(args<span class="sc">$</span>type)){ </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    type<span class="ot">&lt;-</span>args<span class="sc">$</span>type</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    args<span class="sc">$</span>type<span class="ot">&lt;-</span><span class="cn">NULL</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> type<span class="ot">&lt;-</span><span class="st">"rate"</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(args<span class="sc">$</span>show.tree)){</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    show.tree<span class="ot">&lt;-</span>args<span class="sc">$</span>show.tree</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    args<span class="sc">$</span>show.tree<span class="ot">&lt;-</span><span class="cn">NULL</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> show.tree<span class="ot">&lt;-</span><span class="cn">FALSE</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(args<span class="sc">$</span>add)){ </span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    add<span class="ot">&lt;-</span>args<span class="sc">$</span>add</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    args<span class="sc">$</span>add<span class="ot">&lt;-</span><span class="cn">NULL</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> add<span class="ot">&lt;-</span><span class="cn">FALSE</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(args<span class="sc">$</span>ylim)) </span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    args<span class="sc">$</span>ylim<span class="ot">&lt;-</span><span class="cf">if</span>(type<span class="sc">==</span><span class="st">"number"</span>)<span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">max</span>(x<span class="sc">$</span>nchanges)) <span class="cf">else</span> </span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">max</span>(x<span class="sc">$</span>nchanges<span class="sc">/</span>x<span class="sc">$</span>edge.length))</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(args<span class="sc">$</span>xlim))</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    args<span class="sc">$</span>xlim<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">max</span>(x<span class="sc">$</span>segments),<span class="fu">min</span>(x<span class="sc">$</span>segments))</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(args<span class="sc">$</span>lwd)) args<span class="sc">$</span>lwd<span class="ot">&lt;-</span><span class="dv">2</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(args<span class="sc">$</span>xlab)) args<span class="sc">$</span>xlab<span class="ot">&lt;-</span><span class="st">"time since the present"</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(args<span class="sc">$</span>ylab)) </span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    args<span class="sc">$</span>ylab<span class="ot">&lt;-</span><span class="cf">if</span>(type<span class="sc">==</span><span class="st">"number"</span>) <span class="st">"mean number of changes"</span> <span class="cf">else</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>      <span class="st">"mean number of changes / total edge length"</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>  args<span class="sc">$</span>type<span class="ot">&lt;-</span><span class="st">"l"</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  args<span class="sc">$</span>x<span class="ot">&lt;-</span>h<span class="sc">-</span><span class="fu">as.vector</span>(<span class="fu">t</span>(x<span class="sc">$</span>segments))</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>  args<span class="sc">$</span>y<span class="ot">&lt;-</span><span class="cf">if</span>(type<span class="sc">==</span><span class="st">"number"</span>) <span class="fu">rbind</span>(x<span class="sc">$</span>nchanges,x<span class="sc">$</span>nchanges) <span class="cf">else</span> </span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(x<span class="sc">$</span>nchanges<span class="sc">/</span>x<span class="sc">$</span>edge.length,x<span class="sc">$</span>nchanges<span class="sc">/</span>x<span class="sc">$</span>edge.length)</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span>add) <span class="fu">do.call</span>(plot,args)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="fu">do.call</span>(lines,args)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(show.tree) <span class="fu">plotTree</span>(x<span class="sc">$</span>tree,<span class="at">add=</span><span class="cn">TRUE</span>,<span class="at">ftype=</span><span class="st">"off"</span>,<span class="at">lwd=</span><span class="dv">1</span>,</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>                         <span class="at">color=</span><span class="fu">make.transparent</span>(<span class="st">"blue"</span>,<span class="fl">0.1</span>),<span class="at">mar=</span><span class="fu">par</span>()<span class="sc">$</span>mar,</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>                         <span class="at">direction=</span><span class="st">"leftwards"</span>,<span class="at">xlim=</span>args<span class="sc">$</span>xlim)</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.ctt</span>(object_list[[<span class="dv">1</span>]], <span class="at">type=</span><span class="st">"rate"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2_RelativeRates_SI_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.ctt</span>(object_list[[<span class="dv">1</span>]], <span class="at">type=</span><span class="st">"number"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2_RelativeRates_SI_files/figure-html/unnamed-chunk-5-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="post-processing-of-data" class="level1">
<h1>2.1. Post-processing of data</h1>
<p><strong><em>To do:</em></strong></p>
<p>Currently, if there was no transition of a specific type at a specific time, there is no indication of a rate. However, the rate should be zero if there was no transition. In the following code I try to replicate each time segment twice and add transitions for both types with rates == 0.<br>
I’m not done with this yet.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace NAs in Transition types to set the rates to 0 where no transition occurred:</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>rates_df_copy <span class="ot">&lt;-</span> rates_df</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace "NA" with the first transition type</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>rates_df_copy<span class="sc">$</span>transition[<span class="fu">is.na</span>(rates_df_copy<span class="sc">$</span>transition)] <span class="ot">&lt;-</span> <span class="fu">unique</span>(rates_df_copy<span class="sc">$</span>transition)[[<span class="dv">2</span>]]</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a second copy of the data frame with "NA" transitions</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>rates_df_copy2 <span class="ot">&lt;-</span> rates_df</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace "NA" with the second transition type</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>rates_df_copy2<span class="sc">$</span>transition[<span class="fu">is.na</span>(rates_df_copy2<span class="sc">$</span>transition)] <span class="ot">&lt;-</span> <span class="fu">unique</span>(rates_df_copy2<span class="sc">$</span>transition)[[<span class="dv">3</span>]]</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the two copies to get the final data frame with replicates</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>final_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(rates_df_copy, rates_df_copy2)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="do">########## ====================================================================================== ####</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the transition type for which you want to ensure rates</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>specific_transition_type <span class="ot">&lt;-</span> <span class="fu">unique</span>(rates_df_copy<span class="sc">$</span>transition)[[<span class="dv">2</span>]]</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a data frame with all possible combinations of segsID and the specific transition type</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>all_combinations <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">segsID =</span> <span class="fu">unique</span>(final_df<span class="sc">$</span>segsID),</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">transition =</span> specific_transition_type</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Left join the generated data frame with the original data frame</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>final_df1 <span class="ot">&lt;-</span> all_combinations <span class="sc">%&gt;%</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(final_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"segsID"</span>, <span class="st">"transition"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(rate), <span class="dv">0</span>, rate))<span class="co"># Generate a data frame with all possible combinations of segsID and the specific transition type</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>all_combinations <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">segsID =</span> <span class="fu">unique</span>(final_df1<span class="sc">$</span>segsID),</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">transition =</span> specific_transition_type</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Left join the generated data frame with the original data frame</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>final_df1 <span class="ot">&lt;-</span> all_combinations <span class="sc">%&gt;%</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(final_df1, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"segsID"</span>, <span class="st">"transition"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(rate), <span class="dv">0</span>, rate))</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a><span class="do">########## ====================================================================================== ####</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the transition type for which you want to ensure rates</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>specific_transition_type <span class="ot">&lt;-</span> <span class="fu">unique</span>(rates_df_copy<span class="sc">$</span>transition)[[<span class="dv">1</span>]]</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a data frame with all possible combinations of segsID and the specific transition type</span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>all_combinations2 <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">segsID =</span> <span class="fu">unique</span>(final_df<span class="sc">$</span>segsID),</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">transition =</span> specific_transition_type</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Left join the generated data frame with the original data frame</span></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>final_df2 <span class="ot">&lt;-</span> all_combinations2 <span class="sc">%&gt;%</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(final_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"segsID"</span>, <span class="st">"transition"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(rate), <span class="dv">0</span>, rate))<span class="co"># Generate a data frame with all possible combinations of segsID and the specific transition type</span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>all_combinations2 <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">segsID =</span> <span class="fu">unique</span>(final_df2<span class="sc">$</span>segsID),</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">transition =</span> specific_transition_type</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Left join the generated data frame with the original data frame</span></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>final_df2 <span class="ot">&lt;-</span> all_combinations2 <span class="sc">%&gt;%</span></span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(final_df2, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"segsID"</span>, <span class="st">"transition"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(rate), <span class="dv">0</span>, rate))</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a><span class="do">########## ====================================================================================== ####</span></span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the data frame if needed</span></span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>final_df <span class="ot">&lt;-</span> final_df <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(segsID)  <span class="co"># You can specify the sorting order</span></span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Now final_df contains rows with "NA" in the "transition" column replaced by two different transition types.</span></span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(final_df, <span class="fu">aes</span>(<span class="at">y =</span> rate, <span class="at">x =</span> segs_end, <span class="at">fill =</span> <span class="fu">factor</span>(transition))) <span class="sc">+</span></span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"identity"</span>)<span class="sc">+</span></span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="fl">0.015</span>)<span class="sc">+</span></span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4798 rows containing missing values (`geom_col()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="2_RelativeRates_SI_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="plotting-the-rates" class="level3">
<h3 class="anchored" data-anchor-id="plotting-the-rates">Plotting the rates</h3>
<section id="my-adaptation-of-pollination-study-using" class="level4">
<h4 class="anchored" data-anchor-id="my-adaptation-of-pollination-study-using">My adaptation of pollination study using</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="do">## below adapted from other script:  https://github.com/rubysaltbush/pollination-macroevolution/blob/main/scripts/analysis/simmap.R</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>armature_transitions <span class="ot">&lt;-</span> rates_df</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>armature_transitions<span class="sc">$</span>transition <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(armature_transitions<span class="sc">$</span>transition)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co"># build new data frame with cumulative number of transitions</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>armature_trans_cumul <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>){</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  trans <span class="ot">&lt;-</span> armature_transitions <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(N_sim <span class="sc">==</span> n) <span class="sc">%&gt;%</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(transition) <span class="sc">%&gt;%</span><span class="fu">arrange</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">trans_no =</span> <span class="fu">row_number</span>(N_sim))</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  armature_trans_cumul <span class="ot">&lt;-</span> <span class="fu">rbind</span>(armature_trans_cumul, trans)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(n, trans)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================================================================== #</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="co">#  Now we are summarizing over the 100 simulations:</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================================================================== #</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="do">##### copied from somewhere else in the code from the same script....:</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a><span class="co"># first need to know average number of transitions and across simulations, rounded. </span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>trans_avg_length <span class="ot">&lt;-</span> armature_trans_cumul <span class="sc">%&gt;%</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(transition, N_sim) <span class="sc">%&gt;%</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">no_trans =</span> <span class="fu">max</span>(trans_no)) <span class="sc">%&gt;%</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(trans_no <span class="sc">==</span> no_trans) <span class="sc">%&gt;%</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(transition) <span class="sc">%&gt;%</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">avg_length =</span> <span class="fu">round</span>(<span class="fu">mean</span>(no_trans), <span class="at">digits =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(transition, avg_length) <span class="sc">%&gt;%</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">distinct</span>()</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a><span class="co"># now knowing this, can rearrange data and average times and edge.lengths across rows</span></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>avg_trans_times <span class="ot">&lt;-</span> armature_trans_cumul <span class="sc">%&gt;%</span></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(transition, trans_no) <span class="sc">%&gt;%</span></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">avg_time =</span> <span class="fu">mean</span>(time)) <span class="sc">%&gt;%</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">SE_time =</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(time) <span class="sc">/</span> <span class="fu">length</span>(time)),</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>                <span class="at">avg_edge.length =</span> <span class="fu">mean</span>(edge.length)) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(N_sim, segsID, transition) <span class="sc">%&gt;%</span></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">avg_Nchanges =</span> <span class="fu">mean</span>(Nchanges)) <span class="sc">%&gt;%</span></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(transition, trans_no, avg_time, SE_time, avg_edge.length, avg_Nchanges) <span class="sc">%&gt;%</span></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">distinct</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `N_sim`, `segsID`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># reduce avg_trans_times to trans_avg_length</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>avg_trans_times_a2na <span class="ot">&lt;-</span> avg_trans_times <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(transition <span class="sc">==</span> <span class="st">"armature-&gt;no_armature"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(trans_no <span class="sc">&lt;=</span> trans_avg_length[<span class="dv">1</span>,<span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using one column matrices in `filter()` was deprecated in dplyr 1.1.0.
ℹ Please use one dimensional logical vectors instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>avg_trans_times_na2a <span class="ot">&lt;-</span> avg_trans_times <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(transition <span class="sc">==</span> <span class="st">"no_armature-&gt;armature"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(trans_no <span class="sc">&lt;=</span> trans_avg_length[<span class="dv">2</span>,<span class="dv">2</span>])</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>avg_trans_times <span class="ot">&lt;-</span> <span class="fu">rbind</span>(avg_trans_times_a2na, avg_trans_times_na2a)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(avg_trans_times_a2na, avg_trans_times_na2a)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="do">#### Plotting ======================================</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("prettyGraphs") #to set transparancy of colors with "alpha"</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(prettyGraphs)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>myColours <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"lightgrey"</span>, <span class="st">"#FFBB00"</span>)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>myColoursAlpha <span class="ot">&lt;-</span> <span class="fu">add.alpha</span>(myColours, <span class="at">alpha=</span><span class="fl">0.4</span>)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>my_cols <span class="ot">&lt;-</span> <span class="fu">setNames</span>(myColoursAlpha, <span class="fu">c</span>(<span class="st">"armature-&gt;no_armature"</span>, <span class="st">"no_armature-&gt;armature"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="same-thing-in-ggplot2-rates-plot" class="level4">
<h4 class="anchored" data-anchor-id="same-thing-in-ggplot2-rates-plot">same thing in ggplot2 (rates plot)</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.ctt</span>(object, <span class="at">type=</span><span class="st">"rate"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2_RelativeRates_SI_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>no_arm_to_arm <span class="ot">&lt;-</span> armature_transitions <span class="sc">%&gt;%</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(transition <span class="sc">==</span> <span class="st">"no_armature-&gt;armature"</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>arm_to_no_arm <span class="ot">&lt;-</span> armature_transitions <span class="sc">%&gt;%</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(transition <span class="sc">==</span> <span class="st">"armature-&gt;no_armature"</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span>  </span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Armature -&gt; No Armature:</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>(<span class="at">data =</span> arm_to_no_arm, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> rate, <span class="at">colour =</span> <span class="st">"Armature -&gt; no Armature"</span>), <span class="at">pch =</span> <span class="dv">15</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>   <span class="co"># No Armature -&gt; Armature:</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>(<span class="at">data =</span> no_arm_to_arm, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> rate, <span class="at">colour =</span> <span class="st">"No Armature -&gt; Armature"</span>), <span class="at">pch =</span> <span class="dv">17</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="at">data =</span> arm_to_no_arm, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> rate, <span class="at">colour =</span> <span class="st">"Armature -&gt; no Armature"</span>, <span class="at">group =</span> N_sim)) <span class="sc">+</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="at">data =</span> no_arm_to_arm, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> rate, <span class="at">colour =</span> <span class="st">"No Armature -&gt; Armature"</span>,<span class="at">group =</span> N_sim)) <span class="sc">+</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set plot aesthetics</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlim</span>(<span class="dv">45</span>, <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="fl">0.23</span>) <span class="sc">+</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>( <span class="at">values=</span><span class="fu">c</span>(<span class="st">"lightgrey"</span>, <span class="st">"#FFBB00"</span>))<span class="sc">+</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Time since the origin of clade (mya)"</span>,</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Relative Changes per Edge length"</span>,</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Relative Transition Rates"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 17 rows containing missing values (`geom_point()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 12 rows containing missing values (`geom_point()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 17 rows containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 12 rows containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="2_RelativeRates_SI_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> avg_trans_times <span class="sc">%&gt;%</span> <span class="fu">filter</span>(transition <span class="sc">==</span> <span class="st">"armature-&gt;no_armature"</span>), </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> avg_time, <span class="at">y =</span> avg_Nchanges <span class="sc">/</span> avg_edge.length, <span class="at">colour =</span> <span class="st">"Armature -&gt; no Armature"</span>), </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">pch =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_line</span>(<span class="at">data =</span> avg_trans_times <span class="sc">%&gt;%</span> <span class="fu">filter</span>(transition <span class="sc">==</span> <span class="st">"armature-&gt;no_armature"</span>),</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> avg_time, <span class="at">y =</span> avg_Nchanges <span class="sc">/</span> avg_edge.length, <span class="at">colour =</span> <span class="st">"Armature -&gt; no Armature"</span>, <span class="at">group =</span> N_sim)) <span class="sc">+</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> avg_trans_times <span class="sc">%&gt;%</span> <span class="fu">filter</span>(transition <span class="sc">==</span> <span class="st">"no_armature-&gt;armature"</span>),</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> avg_time, <span class="at">y =</span> avg_Nchanges <span class="sc">/</span> avg_edge.length, <span class="at">colour =</span> <span class="st">"No Armature -&gt; Armature"</span>), </span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">pch =</span> <span class="dv">17</span>) <span class="sc">+</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_line</span>(<span class="at">data =</span> avg_trans_times <span class="sc">%&gt;%</span> <span class="fu">filter</span>(transition <span class="sc">==</span> <span class="st">"no_armature-&gt;armature"</span>),</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> avg_time, <span class="at">y =</span> avg_Nchanges <span class="sc">/</span> avg_edge.length, <span class="at">colour =</span> <span class="st">"No Armature -&gt; Armature"</span>,<span class="at">group =</span> N_sim)) <span class="sc">+</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"lightgrey"</span>, <span class="st">"#FFBB00"</span>))<span class="sc">+</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set plot aesthetics</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlim</span>(<span class="dv">45</span>, <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="fl">0.16</span>) <span class="sc">+</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Time since the origin of clade (mya)"</span>,</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Mean Number of Changes/Mean Edge Length"</span>,</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Mean Relative Transition Rates"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2_RelativeRates_SI_files/figure-html/unnamed-chunk-8-3.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="b-mammals" class="level4">
<h4 class="anchored" data-anchor-id="b-mammals">B) Mammals</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../output/RData/Mammals_rates_ws.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="plot.multictt-1" class="level2">
<h2 class="anchored" data-anchor-id="plot.multictt-1">plot.multiCtt()</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>plot.multiCtt<span class="ot">&lt;-</span><span class="cf">function</span>(x,...){</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">hasArg</span>(alpha)) alpha<span class="ot">&lt;-</span><span class="fu">list</span>(...)<span class="sc">$</span>alpha</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> alpha<span class="ot">&lt;-</span><span class="fl">0.05</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  segments<span class="ot">&lt;-</span>x[[<span class="dv">1</span>]]<span class="sc">$</span>segments</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  nchanges<span class="ot">&lt;-</span><span class="fu">sapply</span>(x,<span class="cf">function</span>(x) x<span class="sc">$</span>nchanges)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">hasArg</span>(type)) type<span class="ot">&lt;-</span><span class="fu">list</span>(...)<span class="sc">$</span>type</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> type<span class="ot">&lt;-</span><span class="st">"rate"</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  edge.length<span class="ot">&lt;-</span><span class="fu">sapply</span>(x,<span class="cf">function</span>(x) x<span class="sc">$</span>edge.length)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  obj<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">segments=</span>segments,<span class="at">nchanges=</span><span class="fu">rowMeans</span>(nchanges),</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">edge.length=</span><span class="fu">rowMeans</span>(edge.length),<span class="at">tree=</span>x[[<span class="dv">1</span>]]<span class="sc">$</span>tree)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class</span>(obj)<span class="ot">&lt;-</span><span class="st">"ctt"</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>  lower<span class="ot">&lt;-</span><span class="fu">max</span>(<span class="fu">floor</span>(alpha<span class="sc">/</span><span class="dv">2</span><span class="sc">*</span><span class="fu">length</span>(x)),<span class="dv">1</span>)</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  upper<span class="ot">&lt;-</span><span class="fu">min</span>(<span class="fu">ceiling</span>((<span class="dv">1</span><span class="sc">-</span>alpha<span class="sc">/</span><span class="dv">2</span>)<span class="sc">*</span><span class="fu">length</span>(x)),<span class="fu">ncol</span>(nchanges))</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>  xx<span class="ot">&lt;-</span><span class="fu">max</span>(<span class="fu">nodeHeights</span>(x[[<span class="dv">1</span>]]<span class="sc">$</span>tree))<span class="sc">-</span><span class="fu">as.vector</span>(<span class="fu">t</span>(segments))</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>  xx<span class="ot">&lt;-</span><span class="fu">c</span>(xx,xx[<span class="fu">length</span>(xx)<span class="sc">:</span><span class="dv">1</span>])</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>  y.lower<span class="ot">&lt;-</span><span class="cf">if</span>(type<span class="sc">==</span><span class="st">"number"</span>) <span class="fu">apply</span>(nchanges,<span class="dv">1</span>,sort)[lower,] <span class="cf">else</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(type<span class="sc">==</span><span class="st">"rate"</span>) <span class="fu">apply</span>(nchanges<span class="sc">/</span>edge.length,<span class="dv">1</span>,sort)[lower,]</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>  y.upper<span class="ot">&lt;-</span><span class="cf">if</span>(type<span class="sc">==</span><span class="st">"number"</span>) <span class="fu">apply</span>(nchanges,<span class="dv">1</span>,sort)[upper,] <span class="cf">else</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(type<span class="sc">==</span><span class="st">"rate"</span>) <span class="fu">apply</span>(nchanges<span class="sc">/</span>edge.length,<span class="dv">1</span>,sort)[upper,]</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>  y.lower<span class="ot">&lt;-</span><span class="fu">as.vector</span>(<span class="fu">rbind</span>(y.lower,y.lower))</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>  y.upper<span class="ot">&lt;-</span><span class="fu">as.vector</span>(<span class="fu">rbind</span>(y.upper,y.upper))</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>  yy<span class="ot">&lt;-</span><span class="fu">c</span>(y.lower,y.upper[<span class="fu">length</span>(y.upper)<span class="sc">:</span><span class="dv">1</span>])</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>  args<span class="ot">&lt;-</span><span class="fu">list</span>(...)</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(args<span class="sc">$</span>alpha)) args<span class="sc">$</span>alpha<span class="ot">&lt;-</span><span class="cn">NULL</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(args<span class="sc">$</span>col)) args<span class="sc">$</span>col<span class="ot">&lt;-</span><span class="st">"blue"</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(args<span class="sc">$</span>ylim)) args<span class="sc">$</span>ylim<span class="ot">&lt;-</span><span class="fu">range</span>(yy)</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>  args<span class="sc">$</span>x<span class="ot">&lt;-</span>obj</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">do.call</span>(plot,args)</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">polygon</span>(xx,yy,<span class="at">col=</span><span class="fu">make.transparent</span>(<span class="st">"grey"</span>,<span class="fl">0.4</span>),<span class="at">border=</span><span class="dv">0</span>)</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.multiCtt</span>(object_list, <span class="at">type=</span><span class="st">"rate"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2_RelativeRates_SI_files/figure-html/plot.multiCtt()%20function%20Mammals-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.multiCtt</span>(object_list, <span class="at">type=</span><span class="st">"number"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2_RelativeRates_SI_files/figure-html/plot.multiCtt()%20function%20Mammals-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can also plot the rates of each simulation separately using plot.ctt() from phytools:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">#|label: plot.ctt() function</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>plot.ctt<span class="ot">&lt;-</span><span class="cf">function</span>(x,...){</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  h<span class="ot">&lt;-</span><span class="fu">max</span>(<span class="fu">nodeHeights</span>(x<span class="sc">$</span>tree))</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  args<span class="ot">&lt;-</span><span class="fu">list</span>(...)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(args<span class="sc">$</span>type)){ </span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    type<span class="ot">&lt;-</span>args<span class="sc">$</span>type</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    args<span class="sc">$</span>type<span class="ot">&lt;-</span><span class="cn">NULL</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> type<span class="ot">&lt;-</span><span class="st">"rate"</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(args<span class="sc">$</span>show.tree)){</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    show.tree<span class="ot">&lt;-</span>args<span class="sc">$</span>show.tree</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    args<span class="sc">$</span>show.tree<span class="ot">&lt;-</span><span class="cn">NULL</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> show.tree<span class="ot">&lt;-</span><span class="cn">FALSE</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(args<span class="sc">$</span>add)){ </span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    add<span class="ot">&lt;-</span>args<span class="sc">$</span>add</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    args<span class="sc">$</span>add<span class="ot">&lt;-</span><span class="cn">NULL</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> add<span class="ot">&lt;-</span><span class="cn">FALSE</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(args<span class="sc">$</span>ylim)) </span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    args<span class="sc">$</span>ylim<span class="ot">&lt;-</span><span class="cf">if</span>(type<span class="sc">==</span><span class="st">"number"</span>)<span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">max</span>(x<span class="sc">$</span>nchanges)) <span class="cf">else</span> </span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">max</span>(x<span class="sc">$</span>nchanges<span class="sc">/</span>x<span class="sc">$</span>edge.length))</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(args<span class="sc">$</span>xlim))</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    args<span class="sc">$</span>xlim<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">max</span>(x<span class="sc">$</span>segments),<span class="fu">min</span>(x<span class="sc">$</span>segments))</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(args<span class="sc">$</span>lwd)) args<span class="sc">$</span>lwd<span class="ot">&lt;-</span><span class="dv">2</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(args<span class="sc">$</span>xlab)) args<span class="sc">$</span>xlab<span class="ot">&lt;-</span><span class="st">"time since the present"</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(args<span class="sc">$</span>ylab)) </span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    args<span class="sc">$</span>ylab<span class="ot">&lt;-</span><span class="cf">if</span>(type<span class="sc">==</span><span class="st">"number"</span>) <span class="st">"mean number of changes"</span> <span class="cf">else</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>      <span class="st">"mean number of changes / total edge length"</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>  args<span class="sc">$</span>type<span class="ot">&lt;-</span><span class="st">"l"</span></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>  args<span class="sc">$</span>x<span class="ot">&lt;-</span>h<span class="sc">-</span><span class="fu">as.vector</span>(<span class="fu">t</span>(x<span class="sc">$</span>segments))</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>  args<span class="sc">$</span>y<span class="ot">&lt;-</span><span class="cf">if</span>(type<span class="sc">==</span><span class="st">"number"</span>) <span class="fu">rbind</span>(x<span class="sc">$</span>nchanges,x<span class="sc">$</span>nchanges) <span class="cf">else</span> </span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(x<span class="sc">$</span>nchanges<span class="sc">/</span>x<span class="sc">$</span>edge.length,x<span class="sc">$</span>nchanges<span class="sc">/</span>x<span class="sc">$</span>edge.length)</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span>add) <span class="fu">do.call</span>(plot,args)</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="fu">do.call</span>(lines,args)</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(show.tree) <span class="fu">plotTree</span>(x<span class="sc">$</span>tree,<span class="at">add=</span><span class="cn">TRUE</span>,<span class="at">ftype=</span><span class="st">"off"</span>,<span class="at">lwd=</span><span class="dv">1</span>,</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>                         <span class="at">color=</span><span class="fu">make.transparent</span>(<span class="st">"blue"</span>,<span class="fl">0.1</span>),<span class="at">mar=</span><span class="fu">par</span>()<span class="sc">$</span>mar,</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>                         <span class="at">direction=</span><span class="st">"leftwards"</span>,<span class="at">xlim=</span>args<span class="sc">$</span>xlim)</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.ctt</span>(object_list[[<span class="dv">1</span>]], <span class="at">type=</span><span class="st">"rate"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2_RelativeRates_SI_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.ctt</span>(object_list[[<span class="dv">1</span>]], <span class="at">type=</span><span class="st">"number"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2_RelativeRates_SI_files/figure-html/unnamed-chunk-11-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="post-processing-of-data-1" class="level1">
<h1>2.1. Post-processing of data</h1>
<p><strong><em>To do:</em></strong></p>
<p>Currently, if there was no transition of a specific type at a specific time, there is no indication of a rate. However, the rate should be zero if there was no transition. In the following code I try to replicate each time segment twice and add transitions for both types with rates == 0.<br>
I’m not done with this yet.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make dataframe with rates from the rates_list object for all simulations from the simmap:</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>rates_df <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">rbind.fill</span>(rates_list)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Now set columns: rates, Nchanges to 0 if there was no transition</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the average transition time based on numbered transitions from 100 simmap simulations</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co"># set average timing of 0-transition to mean-segment time </span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co"># then order the dataframe by segment ID:</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>rates_df <span class="ot">&lt;-</span> rates_df <span class="sc">%&gt;%</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(N_sim, segsID, transition) <span class="sc">%&gt;%</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(transition), <span class="dv">0</span>, rate), <span class="co"># set transition rates 0 if there was no transition</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">Nchanges =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(transition), <span class="dv">0</span>, Nchanges), <span class="co"># set Nchanges 0 if there was no transition</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">segs_mean =</span> (segs_end<span class="sc">+</span> segs_start)<span class="sc">/</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="co"># Adjust the threshold (1e-6) as needed</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">avg_time =</span> <span class="fu">ifelse</span>(Nchanges <span class="sc">==</span> <span class="dv">1</span>, time, <span class="fu">mean</span>(time))) <span class="sc">%&gt;%</span>  <span class="co"># set average time = time if there was only 1 change</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">avg_time =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(avg_time), segs_mean, avg_time)) <span class="sc">%&gt;%</span> <span class="co"># set time to mean time bin if there was no transition</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(segsID) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() </span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace NAs in Transition types to set the rates to 0 where no transition occurred:</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>rates_df_copy <span class="ot">&lt;-</span> rates_df</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace "NA" with the first transition type</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>rates_df_copy<span class="sc">$</span>transition[<span class="fu">is.na</span>(rates_df_copy<span class="sc">$</span>transition)] <span class="ot">&lt;-</span> <span class="fu">unique</span>(rates_df_copy<span class="sc">$</span>transition)[[<span class="dv">2</span>]]</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a second copy of the data frame with "NA" transitions</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>rates_df_copy2 <span class="ot">&lt;-</span> rates_df</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace "NA" with the second transition type</span></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>rates_df_copy2<span class="sc">$</span>transition[<span class="fu">is.na</span>(rates_df_copy2<span class="sc">$</span>transition)] <span class="ot">&lt;-</span> <span class="fu">unique</span>(rates_df_copy2<span class="sc">$</span>transition)[[<span class="dv">3</span>]]</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the two copies to get the final data frame with replicates</span></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>final_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(rates_df_copy, rates_df_copy2)</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a><span class="do">########## ====================================================================================== ####</span></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the transition type for which you want to ensure rates</span></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>specific_transition_type <span class="ot">&lt;-</span> <span class="fu">unique</span>(rates_df_copy<span class="sc">$</span>transition)[[<span class="dv">2</span>]]</span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a data frame with all possible combinations of segsID and the specific transition type</span></span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>all_combinations <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">segsID =</span> <span class="fu">unique</span>(final_df<span class="sc">$</span>segsID),</span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">transition =</span> specific_transition_type</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Left join the generated data frame with the original data frame</span></span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a>final_df1 <span class="ot">&lt;-</span> all_combinations <span class="sc">%&gt;%</span></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(final_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"segsID"</span>, <span class="st">"transition"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(rate), <span class="dv">0</span>, rate))<span class="co"># Generate a data frame with all possible combinations of segsID and the specific transition type</span></span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>all_combinations <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">segsID =</span> <span class="fu">unique</span>(final_df1<span class="sc">$</span>segsID),</span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">transition =</span> specific_transition_type</span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Left join the generated data frame with the original data frame</span></span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a>final_df1 <span class="ot">&lt;-</span> all_combinations <span class="sc">%&gt;%</span></span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(final_df1, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"segsID"</span>, <span class="st">"transition"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(rate), <span class="dv">0</span>, rate))</span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a><span class="do">########## ====================================================================================== ####</span></span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the transition type for which you want to ensure rates</span></span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a>specific_transition_type <span class="ot">&lt;-</span> <span class="fu">unique</span>(rates_df_copy<span class="sc">$</span>transition)[[<span class="dv">1</span>]]</span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a data frame with all possible combinations of segsID and the specific transition type</span></span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a>all_combinations2 <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">segsID =</span> <span class="fu">unique</span>(final_df<span class="sc">$</span>segsID),</span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">transition =</span> specific_transition_type</span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Left join the generated data frame with the original data frame</span></span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a>final_df2 <span class="ot">&lt;-</span> all_combinations2 <span class="sc">%&gt;%</span></span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(final_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"segsID"</span>, <span class="st">"transition"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(rate), <span class="dv">0</span>, rate))<span class="co"># Generate a data frame with all possible combinations of segsID and the specific transition type</span></span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a>all_combinations2 <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a>  <span class="at">segsID =</span> <span class="fu">unique</span>(final_df2<span class="sc">$</span>segsID),</span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a>  <span class="at">transition =</span> specific_transition_type</span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Left join the generated data frame with the original data frame</span></span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a>final_df2 <span class="ot">&lt;-</span> all_combinations2 <span class="sc">%&gt;%</span></span>
<span id="cb40-85"><a href="#cb40-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(final_df2, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"segsID"</span>, <span class="st">"transition"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb40-86"><a href="#cb40-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rate =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(rate), <span class="dv">0</span>, rate))</span>
<span id="cb40-87"><a href="#cb40-87" aria-hidden="true" tabindex="-1"></a><span class="do">########## ====================================================================================== ####</span></span>
<span id="cb40-88"><a href="#cb40-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-89"><a href="#cb40-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-90"><a href="#cb40-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-91"><a href="#cb40-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the data frame if needed</span></span>
<span id="cb40-92"><a href="#cb40-92" aria-hidden="true" tabindex="-1"></a>final_df <span class="ot">&lt;-</span> final_df <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(segsID)  <span class="co"># You can specify the sorting order</span></span>
<span id="cb40-93"><a href="#cb40-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-94"><a href="#cb40-94" aria-hidden="true" tabindex="-1"></a><span class="co"># Now final_df contains rows with "NA" in the "transition" column replaced by two different transition types.</span></span>
<span id="cb40-95"><a href="#cb40-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-96"><a href="#cb40-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-97"><a href="#cb40-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-98"><a href="#cb40-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-99"><a href="#cb40-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-100"><a href="#cb40-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-101"><a href="#cb40-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-102"><a href="#cb40-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-103"><a href="#cb40-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-104"><a href="#cb40-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-105"><a href="#cb40-105" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(final_df, <span class="fu">aes</span>(<span class="at">y =</span> rate, <span class="at">x =</span> segs_end, <span class="at">fill =</span> <span class="fu">factor</span>(transition))) <span class="sc">+</span></span>
<span id="cb40-106"><a href="#cb40-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"identity"</span>)<span class="sc">+</span></span>
<span id="cb40-107"><a href="#cb40-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="fl">0.015</span>)<span class="sc">+</span></span>
<span id="cb40-108"><a href="#cb40-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 600 rows containing missing values (`geom_col()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="2_RelativeRates_SI_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="plotting-the-rates-1" class="level3">
<h3 class="anchored" data-anchor-id="plotting-the-rates-1">Plotting the rates</h3>
<section id="my-adaptation-of-pollination-study-using-1" class="level4">
<h4 class="anchored" data-anchor-id="my-adaptation-of-pollination-study-using-1">My adaptation of pollination study using</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="do">## below adapted from other script:  https://github.com/rubysaltbush/pollination-macroevolution/blob/main/scripts/analysis/simmap.R</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>megaherbivore_transitions <span class="ot">&lt;-</span> rates_df</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>megaherbivore_transitions<span class="sc">$</span>transition <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(megaherbivore_transitions<span class="sc">$</span>transition)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co"># build new data frame with cumulative number of transitions</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>megaherbivore_trans_cumul <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>){</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  trans <span class="ot">&lt;-</span> megaherbivore_transitions <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span>  </span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(N_sim <span class="sc">==</span> n) <span class="sc">%&gt;%</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(transition) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">trans_no =</span> <span class="fu">row_number</span>(N_sim))</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>  megaherbivore_trans_cumul <span class="ot">&lt;-</span> <span class="fu">rbind</span>(megaherbivore_trans_cumul, trans)</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(n, trans)</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================================================================== #</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a><span class="co">#  Now we are summarizing over the 100 simulations:</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================================================================== #</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a><span class="do">##### copied from somewhere else in the code from the same script....:</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a><span class="co"># first need to know average number of transitions and across simulations, rounded. </span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>trans_avg_length <span class="ot">&lt;-</span> megaherbivore_trans_cumul <span class="sc">%&gt;%</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(transition, N_sim) <span class="sc">%&gt;%</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">no_trans =</span> <span class="fu">max</span>(trans_no)) <span class="sc">%&gt;%</span></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(trans_no <span class="sc">==</span> no_trans) <span class="sc">%&gt;%</span></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(transition) <span class="sc">%&gt;%</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">avg_length =</span> <span class="fu">round</span>(<span class="fu">mean</span>(no_trans), <span class="at">digits =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(transition, avg_length) <span class="sc">%&gt;%</span></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">distinct</span>()</span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a><span class="co"># now knowing this, can rearrange data and average times and edge.lengths across rows</span></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>avg_trans_times <span class="ot">&lt;-</span> megaherbivore_trans_cumul <span class="sc">%&gt;%</span></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(transition, trans_no) <span class="sc">%&gt;%</span></span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">avg_time =</span> <span class="fu">mean</span>(time)) <span class="sc">%&gt;%</span></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">SE_time =</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(time) <span class="sc">/</span> <span class="fu">length</span>(time)),</span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>                <span class="at">avg_edge.length =</span> <span class="fu">mean</span>(edge.length)) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(N_sim, segsID, transition) <span class="sc">%&gt;%</span></span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">avg_Nchanges =</span> <span class="fu">mean</span>(Nchanges)) <span class="sc">%&gt;%</span></span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(transition, trans_no, avg_time, SE_time, avg_edge.length, avg_Nchanges) <span class="sc">%&gt;%</span></span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">distinct</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `N_sim`, `segsID`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># reduce avg_trans_times to trans_avg_length</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>avg_trans_times_m2o <span class="ot">&lt;-</span> avg_trans_times <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(transition <span class="sc">==</span> <span class="st">"megaherbivore-&gt;other"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(trans_no <span class="sc">&lt;=</span> trans_avg_length[<span class="dv">1</span>,<span class="dv">2</span>])</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>avg_trans_times_o2m <span class="ot">&lt;-</span> avg_trans_times <span class="sc">%&gt;%</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(transition <span class="sc">==</span> <span class="st">"other-&gt;megaherbivore"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(trans_no <span class="sc">&lt;=</span> trans_avg_length[<span class="dv">2</span>,<span class="dv">2</span>])</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>avg_trans_times <span class="ot">&lt;-</span> <span class="fu">rbind</span>(avg_trans_times_m2o, avg_trans_times_o2m)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(avg_trans_times_m2o, avg_trans_times_o2m)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="do">#### Plotting ======================================</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("prettyGraphs") #to set transparancy of colors with "alpha"</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(prettyGraphs)</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>myColours <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"lightgrey"</span>, <span class="st">"#FFBB00"</span>)</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>myColoursAlpha <span class="ot">&lt;-</span> <span class="fu">add.alpha</span>(myColours, <span class="at">alpha=</span><span class="fl">0.4</span>)</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>my_cols <span class="ot">&lt;-</span> <span class="fu">setNames</span>(myColoursAlpha, <span class="fu">c</span>(<span class="st">"megaherbivore-&gt;other"</span>, <span class="st">"other-&gt;megaherbivore"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="same-thing-in-ggplot2-rates-plot-1" class="level4">
<h4 class="anchored" data-anchor-id="same-thing-in-ggplot2-rates-plot-1">same thing in ggplot2 (rates plot)</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.ctt</span>(object, <span class="at">type=</span><span class="st">"rate"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2_RelativeRates_SI_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>no_mega_to_mega <span class="ot">&lt;-</span> megaherbivore_transitions <span class="sc">%&gt;%</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(transition <span class="sc">==</span> <span class="st">"other-&gt;megaherbivore"</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>mega_to_no_mega <span class="ot">&lt;-</span> megaherbivore_transitions <span class="sc">%&gt;%</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(transition <span class="sc">==</span> <span class="st">"megaherbivore-&gt;other"</span>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span>  </span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># megaherbivore -&gt; other:</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>(<span class="at">data =</span> mega_to_no_mega, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> rate, <span class="at">colour =</span> <span class="st">"megaherbivore -&gt; other"</span>), <span class="at">pch =</span> <span class="dv">15</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>   <span class="co"># other -&gt; megaherbivore:</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>(<span class="at">data =</span> no_mega_to_mega, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> rate, <span class="at">colour =</span> <span class="st">"other -&gt; megaherbivore"</span>), <span class="at">pch =</span> <span class="dv">17</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="at">data =</span> mega_to_no_mega, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> rate, <span class="at">colour =</span> <span class="st">"megaherbivore -&gt; other"</span>, <span class="at">group =</span> N_sim)) <span class="sc">+</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="at">data =</span> no_mega_to_mega, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> rate, <span class="at">colour =</span> <span class="st">"other -&gt; megaherbivore"</span>,<span class="at">group =</span> N_sim)) <span class="sc">+</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set plot aesthetics</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlim</span>(<span class="dv">220</span>, <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>( <span class="at">values=</span><span class="fu">c</span>(<span class="st">"lightgrey"</span>, <span class="st">"#FFBB00"</span>))<span class="sc">+</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Time since the origin of clade (mya)"</span>,</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Relative Changes per Edge length"</span>,</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Relative Transition Rates"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 10 rows containing missing values (`geom_point()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 10 rows containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="2_RelativeRates_SI_files/figure-html/unnamed-chunk-14-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> avg_trans_times <span class="sc">%&gt;%</span> <span class="fu">filter</span>(transition <span class="sc">==</span> <span class="st">"megaherbivore-&gt;other"</span>), </span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> avg_time, <span class="at">y =</span> avg_Nchanges <span class="sc">/</span> avg_edge.length, <span class="at">colour =</span> <span class="st">"megaherbivore -&gt; other"</span>), </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">pch =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_line</span>(<span class="at">data =</span> avg_trans_times <span class="sc">%&gt;%</span> <span class="fu">filter</span>(transition <span class="sc">==</span> <span class="st">"megaherbivore-&gt;other"</span>),</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> avg_time, <span class="at">y =</span> avg_Nchanges <span class="sc">/</span> avg_edge.length, <span class="at">colour =</span> <span class="st">"megaherbivore -&gt; other"</span>, <span class="at">group =</span> N_sim)) <span class="sc">+</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> avg_trans_times <span class="sc">%&gt;%</span> <span class="fu">filter</span>(transition <span class="sc">==</span> <span class="st">"other-&gt;megaherbivore"</span>),</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> avg_time, <span class="at">y =</span> avg_Nchanges <span class="sc">/</span> avg_edge.length, <span class="at">colour =</span> <span class="st">"other -&gt; megaherbivore"</span>), </span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">pch =</span> <span class="dv">17</span>) <span class="sc">+</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_line</span>(<span class="at">data =</span> avg_trans_times <span class="sc">%&gt;%</span> <span class="fu">filter</span>(transition <span class="sc">==</span> <span class="st">"other-&gt;megaherbivore"</span>),</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> avg_time, <span class="at">y =</span> avg_Nchanges <span class="sc">/</span> avg_edge.length, <span class="at">colour =</span> <span class="st">"other -&gt; megaherbivore"</span>,<span class="at">group =</span> N_sim)) <span class="sc">+</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"lightgrey"</span>, <span class="st">"#FFBB00"</span>))<span class="sc">+</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set plot aesthetics</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#xlim(220, 0) +</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="fl">0.08</span>) <span class="sc">+</span></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Time since the origin of clade (mya)"</span>,</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Mean Number of Changes/Mean Edge Length"</span>,</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Mean Relative Transition Rates"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2_RelativeRates_SI_files/figure-html/unnamed-chunk-14-3.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>